"use strict";function toggleDropdown(e){const t=document.getElementById(e);t&&t.classList.toggle("hidden")}function selectTemplate(e){let t=$(e).data("val"),a=$(e).data("name");$("#template").val(t),$("#template-name").text(a)}function proceedToStep(e){e=Math.max(1,Math.min(3,e)),$(".campaign-form").toggleClass("hidden",1!==e),$(".variable-form").toggleClass("hidden",2!==e),$(".final-form").toggleClass("hidden",3!==e),$(".back-button").toggleClass("hidden",1===e);const t=$("button[data-step]:not(.back-button)"),a=3===e?jsLang("Start Campaign"):jsLang("Next");$(".button-name").text(a);const n=3===e?"submit":"button";3===e?t.removeClass("step-button").prop("type",n):t.addClass("step-button").prop("type",n),$(".StepperParent .Stepper").each((function(t){const a=e-1,n=$(this).find(".empty-circle"),d=$(this).find(".full-circle");t<=a?(n.addClass("hidden"),d.removeClass("hidden")):(n.removeClass("hidden"),d.addClass("hidden"))})),$(".step-button").attr("data-step",e).data("step",e),t.attr("data-step",e).data("step",e)}function setPreviewValue(e,t){const a=$(e).val(),n=$(".template-container").find("strong"+t);n.length>0&&n.text(a)}function handleFilePreview(e){const t=e.files[0];if(!t)return;const a=$(e),n=a.data("preview-id"),d=a.data("preview-section-id"),i=a.data("delete-btn-id"),o=a.data("upload-label-id"),s=a.data("preview-container-id"),r=$("#"+s),l=$("#"+d+"-img"),c=$("#"+d+"-video"),m=$("#"+d+"-doc"),u=$("#"+d+"-filename"),p=$("#"+i),h=$("#"+o),f=t.type,v=f.startsWith("image/"),g=f.startsWith("video/"),b="application/pdf"===f||t.name.toLowerCase().endsWith(".pdf");l.addClass("hidden"),c.addClass("hidden"),m.addClass("hidden");const C=new FileReader;if(v)C.onload=function(e){l.attr("src",e.target.result),l.removeClass("hidden"),r.removeClass("hidden"),h.addClass("hidden"),p.removeClass("hidden"),updatePreviewSection(n,e.target.result,"image")},C.readAsDataURL(t);else if(g)C.onload=function(e){c.attr("src",e.target.result),c.removeClass("hidden"),r.removeClass("hidden"),h.addClass("hidden"),p.removeClass("hidden"),updatePreviewSection(n,e.target.result,"video")},C.readAsDataURL(t);else if(b){u.text(t.name),m.removeClass("hidden"),r.removeClass("hidden"),h.addClass("hidden"),p.removeClass("hidden");const e=URL.createObjectURL(t);updatePreviewSection(n,e,"document",t.name)}else u.text(t.name),m.removeClass("hidden"),r.removeClass("hidden"),h.addClass("hidden"),p.removeClass("hidden"),updatePreviewSection(n,"","document",t.name)}document.addEventListener("click",(function(e){if(!e.target.closest('[onclick*="toggleDropdown"]')){document.querySelectorAll('.campaign-dropdown, [id$="-dropdown"]').forEach((e=>{e.classList.contains("hidden")||e.classList.add("hidden")}))}})),$(document).on("submit","#campaign-form",(function(e){e.preventDefault();const t=$(this),a=new FormData(this),n=t.find('button[type="submit"]');function d(){n.prop("disabled",!1).find("span.button-name").text(jsLang("Start Campaign")).end().find(".arrow-icon").removeClass("hidden").end().find(".loader-icon").addClass("hidden")}$.ajax({url:route,type:"POST",data:a,cache:!1,contentType:!1,processData:!1,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+ACCESS_TOKEN),n.prop("disabled",!0).find(".loader-icon").removeClass("hidden").end().find("span.button-name").text(jsLang("Sending...")).end().find(".arrow-icon").addClass("hidden")},success:function(e){if("info"===e.status)return toastMixin.fire({title:e.message,icon:"error"}),void d();d(),toastMixin.fire({title:e.message,icon:"success"})},error:function(e,t,a){d(),toastMixin.fire({title:e.responseJSON?.error,icon:"error"})},complete:function(){d()}})})),$(document).on("click",".openModalBtn",(function(){$(".delete-campaign").attr("data-id",$(this).data("id"))})),$(document).on("click",".delete-campaign",(function(){let e=$(this).attr("data-id");$(".loader").removeClass("hidden"),$(".delete-campaign").attr("disabled"),doAjaxprocess(SITE_URL+"/user/marketing-bot/campaigns/delete/"+e,{id:e,_token:CSRF_TOKEN},"delete","json").done((function(t,a,n){if("info"===t.status)return toastMixin.fire({title:t.message,icon:"error"}),$(".loader").addClass("hidden"),$(".delete-campaign").removeAttr("disabled"),void $(".closeModalBtn").click();toastMixin.fire({title:t.message,icon:"success"}),$("#campaign-row-"+e).remove(),$(".loader").addClass("hidden"),$(".delete-campaign").removeAttr("disabled"),$(".closeModalBtn").click()})).fail((function(e,t,a){toastMixin.fire({title:JSON.parse(e.responseText).error,icon:t}),$(".loader").addClass("hidden"),$(".delete-campaign").removeAttr("disabled"),$(".closeModalBtn").click()}))})),$(document).on("click",".step-button",(function(e){e.preventDefault();const t=$(this),a=t.hasClass("back-button");let n=parseInt(t.attr("data-step"))||1;if(!a&&1===n){let e=!0;if($(".campaign-form .form-control[required]").each((function(){this.checkValidity()||($(this).trigger("invalid"),e=!1)})),!e)return!1;const t=$("#template").val();return void $.ajax({url:SITE_URL+`/user/marketing-bot/campaigns/whatsapp/template/${t}`,type:"GET",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+ACCESS_TOKEN)},success:function(e){$(".variable-form").html(e.variableForm),$(".preview-section").html(e.previewForm),proceedToStep(n+1)},error:function(e,t,a){toastMixin.fire({title:a,icon:"error"})}})}proceedToStep(a?n-1:n+1)}));const objectUrlStore={};function updatePreviewSection(e,t,a,n){const d=$(".template-container").find("#"+e);d.length>0&&(objectUrlStore[e]&&(URL.revokeObjectURL(objectUrlStore[e]),delete objectUrlStore[e]),"image"===a?d.is("img")?d.attr("src",t):d.html('<img src="'+t+'" alt="preview" class="w-full h-auto rounded-lg" />'):"video"===a?(t&&t.startsWith("blob:")&&(objectUrlStore[e]=t),d.is("video")?d.attr("src",t):d.html('<video src="'+t+'" controls class="w-full h-auto rounded-lg"></video>')):"document"===a&&(t&&t.startsWith("blob:")&&(objectUrlStore[e]=t),t?d.html('<iframe src="'+t+'" class="w-full h-64 rounded-lg" frameborder="0"></iframe>'):d.html('<div class="p-4 bg-gray-100 rounded-lg"><p class="text-sm text-gray-600">'+(n||"Document")+"</p></div>")))}function removeFilePreview(e,t,a,n,d,i){const o=$("#"+e),s=$("#"+i),r=$("#"+a+"-img"),l=$("#"+a+"-video"),c=$("#"+a+"-doc"),m=$("#"+n),u=$("#"+d),p=$(".template-container").find("#"+t);o.val("");const h=l.attr("src");h&&h.startsWith("blob:")&&URL.revokeObjectURL(h),objectUrlStore[t]&&(URL.revokeObjectURL(objectUrlStore[t]),delete objectUrlStore[t]),r.addClass("hidden").attr("src",""),l.addClass("hidden").attr("src",""),c.addClass("hidden"),s.addClass("hidden"),m.addClass("hidden"),u.removeClass("hidden"),p.length>0&&p.empty()}$(document).on("change",".file-upload-input",(function(){handleFilePreview(this)})),$(document).on("click",'[id$="-deleteBtn"]',(function(e){e.preventDefault(),e.stopPropagation();const t=$(this);removeFilePreview(t.data("input-id"),t.data("preview-id"),t.data("preview-section-id"),t.data("delete-btn-id"),t.data("upload-label-id"),t.data("preview-container-id"))})),$(document).on("change","#chatProvider",(function(){var e=$(this).val();$(".ProviderOptions").addClass("hidden"),$("."+e+"_div").removeClass("hidden")})),$(document).on("change","#embeddingProvider",(function(){var e=$(this).val();$(".EmbeddingProviderOptions").addClass("hidden"),$("."+e+"_div").removeClass("hidden")}));