let searchCampaignsTimeout=null;function searchCampaigns(e){const t=e.value;searchCampaignsTimeout&&clearTimeout(searchCampaignsTimeout),searchCampaignsTimeout=setTimeout((()=>{const e=document.getElementById("campaigns-table-container");if(!e)return;const n=e.querySelectorAll(".table-skeleton"),a=e.querySelectorAll(".table-content");n.forEach((e=>e.classList.remove("hidden"))),a.forEach((e=>e.classList.add("hidden"))),fetch(`${campaignRoute}?search=${encodeURIComponent(t)}`,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>{if(!e.ok)throw new Error(jsLang("Network error"));return e.json()})).then((t=>{if(e&&t.items){e.innerHTML=t.items;const n=e.querySelectorAll(".table-skeleton"),a=e.querySelectorAll(".table-content");n.forEach((e=>e.classList.add("hidden"))),a.forEach((e=>e.classList.remove("hidden")))}})).catch((t=>{const n=e.querySelectorAll(".table-skeleton"),a=e.querySelectorAll(".table-content");n.forEach((e=>e.classList.add("hidden"))),a.forEach((e=>{e.classList.remove("hidden"),e.innerHTML=`<div class="text-center py-8 text-red-500">${jsLang("Search failed")}</div>`}))}))}),500)}function filterCampaignsByType(e,t){const n=e.getAttribute("data-value");"status"===t?(document.querySelector(".filter-status").textContent=e.textContent,document.querySelector(".filter-status").setAttribute("data-value",n)):"training"===t&&(document.querySelector(".filter-training").textContent=e.textContent,document.querySelector(".filter-training").setAttribute("data-value",n));const a=document.getElementById("campaign-search").value||"";let d=`${campaignRoute}?`;a&&(d+=`search=${encodeURIComponent(a)}&`),"all"!==n&&(d+=`${t}=${n}&`),d=d.replace(/&$/,"");const o=document.getElementById("campaigns-table-container");if(!o)return;const i=o.querySelectorAll(".table-skeleton"),s=o.querySelectorAll(".table-content");i.forEach((e=>e.classList.remove("hidden"))),s.forEach((e=>e.classList.add("hidden"))),fetch(d,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>{if(!e.ok)throw new Error(jsLang("Network error"));return e.json()})).then((e=>{if(o&&e.items){o.innerHTML=e.items;const t=o.querySelectorAll(".table-skeleton"),n=o.querySelectorAll(".table-content");t.forEach((e=>e.classList.add("hidden"))),n.forEach((e=>e.classList.remove("hidden")))}})).catch((e=>{const t=o.querySelectorAll(".table-skeleton"),n=o.querySelectorAll(".table-content");t.forEach((e=>e.classList.add("hidden"))),n.forEach((e=>{e.classList.remove("hidden"),e.innerHTML=`<div class="text-center py-8 text-red-500">${jsLang("Filter failed")}</div>`}))}))}function openEditModal(e){document.getElementById("edit_campaign_title").value=jsLang("Loading...");const t="undefined"!=typeof editCampaignRouteTemplate&&editCampaignRouteTemplate?editCampaignRouteTemplate.replace("__ID__",e):`${campaignRoute}/${e}/edit`;fetch(t,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then((e=>{if(!e.ok)throw new Error(jsLang("Network response was not ok: ")+e.status);return e.json()})).then((e=>{document.getElementById("edit_campaign_id").value=e.id,document.getElementById("edit_campaign_title").value=e.title||"";let t=e.ends_at||"";t&&t.includes(" ")&&(t=t.split(" ")[0]);const n=document.getElementById("edit_end_date");n.value=t;const a=document.getElementById("end_date_disabled_message");"published"===e.status?(n.readOnly=!0,n.disabled=!0,n.classList.add("bg-gray-100","dark:bg-color-47","cursor-not-allowed","opacity-75"),a.classList.remove("hidden")):(n.readOnly=!1,n.disabled=!1,n.classList.remove("bg-gray-100","dark:bg-color-47","cursor-not-allowed","opacity-75"),a.classList.add("hidden"));const d=document.getElementById("edit_ai_reply"),o=(document.getElementById("aiReplyOptions"),e.ai_reply||e.metas?.find((e=>"ai_reply"===e.key))?.value),i="on"===o||!0===o||1===o||"1"===o;d&&(d.value=i?"on":"",d.checked=i);const s=e=>{"undefined"!=typeof $?$(e).trigger("change"):e.dispatchEvent(new Event("change"))},l=()=>{const t=document.getElementById("aiReplyOptions"),n=document.getElementById("edit_ai_reply");if(t&&n)if(n.checked){if(t.classList.remove("hidden"),e.chat_provider){const t=document.getElementById("chatProvider");t&&(t.value=e.chat_provider,s(t))}if(e.chat_model){const t=document.getElementById("chatModel");t&&(t.value=e.chat_model)}if(e.embedding_provider){const t=document.getElementById("embeddingProvider");t&&(t.value=e.embedding_provider,s(t))}if(e.embedding_model){const t=document.getElementById("embeddingModel");t&&(t.value=e.embedding_model)}}else t.classList.add("hidden")},c=document.getElementById("edit_schedule_toggle"),r=document.getElementById("edit_schedule_options"),u=document.getElementById("edit_schedule_date"),m=document.getElementById("edit_schedule_time"),g="on"===e.schedule||!0===e.schedule;if(c.checked=g,g)if(r.classList.remove("hidden"),e.schedule_at){const t=new Date(e.schedule_at);u.value=formatDateToYMD(t),m.value=formatTimeToHM(t)}else{const e=new Date;u.value=formatDateToYMD(e),m.value=formatTimeToHM(e)}else r.classList.add("hidden"),u.value="",m.value="";const p=document.getElementById("editCampaignModal");p?(p.classList.remove("hidden"),setTimeout((()=>{p.classList.add("opacity-100");const e=p.querySelector(".modalBox");e&&(e.classList.remove("scale-0","opacity-0"),e.classList.add("scale-100","opacity-100")),setTimeout((()=>l()),100)}),10)):void 0!==window.modalUtils&&window.modalUtils.openModal&&(window.modalUtils.openModal("editCampaignModal"),setTimeout((()=>l()),100))})).catch((e=>{toastMixin.fire({title:jsLang("Error loading campaign data. Please try again."),icon:"error"})}))}function updateCampaign(e){const t=new FormData(e),n=document.getElementById("edit_campaign_id").value,a=e.querySelector('button[type="submit"]'),d=a.querySelector(".loader-icon"),o=a.querySelector("span");document.getElementById("edit_end_date").disabled&&t.delete("ends_at");const i=document.getElementById("edit_ai_reply"),s=document.getElementById("edit_schedule_toggle");i&&i.checked?t.set("ai_reply","on"):(t.delete("ai_reply"),t.delete("chat_provider"),t.delete("chat_model"),t.delete("embedding_provider"),t.delete("embedding_model")),s&&s.checked?t.set("schedule","on"):(t.delete("schedule"),t.delete("schedule_date"),t.delete("schedule_time")),o.textContent=jsLang("Updating..."),d.classList.remove("hidden"),a.disabled=!0;const l="undefined"!=typeof updateCampaignRouteTemplate&&updateCampaignRouteTemplate?updateCampaignRouteTemplate.replace("__ID__",n):`${campaignRoute}/${n}`;t.append("_method","PUT"),fetch(l,{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('input[name="_token"]').value}}).then((async e=>{const t=await e.json();if(!e.ok){let n=jsLang("Error updating campaign. Please try again.");if(422===e.status&&t.errors){const e=[];for(const n in t.errors)Array.isArray(t.errors[n])?e.push(...t.errors[n]):e.push(t.errors[n]);n=e.length>0?e.join("<br>"):jsLang("Validation failed. Please check your input.")}else t.error?n=t.error:t.message&&(n=t.message);throw new Error(n)}return t})).then((e=>{if(!e.success)throw new Error(e.error||e.message||jsLang("Failed to update campaign"));closeModal("editCampaignModal"),toastMixin.fire({title:jsLang("Campaign updated successfully."),icon:"success"}),setTimeout((()=>{window.location.reload()}),1e3)})).catch((e=>{const t=e.message||jsLang("Error updating campaign. Please try again.");toastMixin.fire({title:t,icon:"error"}),console.error("Update campaign error:",e)})).finally((()=>{o.textContent=jsLang("Update"),d.classList.add("hidden"),a.disabled=!1}))}function formatDateToYMD(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function formatTimeToHM(e){return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("campaign-search");e&&e.addEventListener("input",(function(e){searchCampaigns(e.target)}))})),document.addEventListener("click",(function(e){const t=e.target.closest("a[data-campaign-id]");if(t&&t.getAttribute("data-campaign-id")){e.preventDefault();openEditModal(t.getAttribute("data-campaign-id"))}})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("edit_schedule_toggle"),t=document.getElementById("edit_schedule_options"),n=document.getElementById("edit_schedule_date"),a=document.getElementById("edit_schedule_time");e&&e.addEventListener("change",(function(){if(this.checked){if(t.classList.remove("hidden"),!n.value){const e=new Date;n.value=formatDateToYMD(e)}if(!a.value){const e=new Date;a.value=formatTimeToHM(e)}}else t.classList.add("hidden"),n.value="",a.value=""}));const d=document.getElementById("edit_ai_reply"),o=document.getElementById("aiReplyOptions");d&&o&&d.addEventListener("change",(function(){o.classList.toggle("hidden",!this.checked)}));const i=document.getElementById("edit-campaign-form");i&&i.addEventListener("submit",(function(e){e.preventDefault(),updateCampaign(this)}))}));