"use strict";let activeConversationId=null,messagePagination={currentPage:1,hasPreviousPage:!1,hasMorePages:!0,isLoading:!1};function scrollToBottom(){const e=$(".message-container");if(e.length&&e.length>0){const a=e[0];a.scrollTop=a.scrollHeight;const n=e.find("> *").last();n.length>0&&n[0].scrollIntoView({behavior:"instant",block:"end"})}}function generateTopSkeletonLoader(){return'\n        <div class="message-top-skeleton-loader space-y-6">\n            \x3c!-- Bot Message Skeleton (Right side) --\x3e\n            <div class="ml-auto w-72">\n                <div class="bg-gradient-to-r from-gray-100 to-gray-50 dark:from-gray-800 dark:to-gray-700 border border-gray-200 dark:border-gray-600 rounded-2xl p-5 animate-pulse">\n                    <div class="space-y-3">\n                        <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-3/4"></div>\n                        <div class="space-y-2">\n                            <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-full"></div>\n                        </div>\n                        <div class="mt-4 flex items-center justify-between">\n                            <div class="h-6 bg-gray-300 dark:bg-gray-600 rounded-full w-20"></div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            \x3c!-- User Message Skeleton (Left side) --\x3e\n            <div class="flex items-start gap-4">\n                <div class="shrink-0 w-12 h-12 bg-gray-300 dark:bg-gray-600 rounded-full animate-pulse"></div>\n                <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md px-6 py-4 max-w-xs border border-gray-200 dark:border-gray-600 animate-pulse">\n                    <div class="space-y-2">\n                        <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-full"></div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    '}function setupMessageScrollListener(e){const a=$(".message-container");a.off("scroll.messagePagination"),a.on("scroll.messagePagination",(function(){$(this).scrollTop()<=50&&!messagePagination.isLoading&&loadPreviousMessages(e)}))}function loadPreviousMessages(e){if(messagePagination.isLoading)return;if(!messagePagination.hasMorePages)return;const a=$(".message-container");if(0===a.length)return;messagePagination.isLoading=!0;const n=messagePagination.currentPage+1,o=a[0].scrollTop,r=a[0].scrollHeight,s=generateTopSkeletonLoader();a.prepend(s),$.ajax({url:SITE_URL+`/user/marketing-bot/conversation/${e}/messages`,type:"GET",data:{page:n},beforeSend(e){e.setRequestHeader("Authorization",`Bearer ${ACCESS_TOKEN}`)},success:function(e){a.find(".message-top-skeleton-loader").remove();const n=$("<div>").html(e.messages).find(".message-container").children();if(n.length>0){n.toArray().reverse().forEach((function(e){a.prepend(e)})),requestAnimationFrame((function(){const e=a[0].scrollHeight-r;a[0].scrollTop=o+e}))}void 0!==e.currentPage&&(messagePagination.currentPage=e.currentPage,messagePagination.hasPreviousPage=e.hasPreviousPage||!1,messagePagination.hasMorePages=void 0===e.hasMorePages||e.hasMorePages),messagePagination.isLoading=!1},error:function(){a.find(".message-top-skeleton-loader").remove(),messagePagination.isLoading=!1}})}function getMessages(e){let a=e.getAttribute("data-inbox-id"),n=e.getAttribute("data-channel");setTimeout((function(){$(".main-header-container").addClass("hidden"),$('[id^="conversation-row-"]').removeClass("hidden"),$(".skeleton-header-container").removeClass("hidden"),$('[class^="inbox-conversation-row-skeleton"]').addClass("hidden")}),500),activeConversationId=a,messagePagination.currentPage=1,messagePagination.hasPreviousPage=!1,messagePagination.hasMorePages=!0,messagePagination.isLoading=!1,$.ajax({url:SITE_URL+`/user/marketing-bot/conversation/${a}/messages`,type:"GET",beforeSend(e){e.setRequestHeader("Authorization",`Bearer ${ACCESS_TOKEN}`)},success:function(e){$('[id^="conversation-row-"]').removeClass("border-2 border-purple-200 dark:border-purple-700 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"),$('[id^="conversation-row-"]').addClass("bg-white dark:bg-color-33 border border-white dark:border-color-47 hover:border-color-89 dark:hover:border-color-89");const o=$("#conversation-row-"+a);o.removeClass("bg-white dark:bg-color-33 border border-white dark:border-color-47 hover:border-color-89 dark:hover:border-color-89"),o.addClass("border-2 border-purple-200 dark:border-purple-700 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200");const r=o.find("span.absolute").filter((function(){return/^\d+\+?$/.test($(this).text().trim())}));if(r.length){const e=parseInt(r.text().replace("+",""))||0;r.remove();const a=$("#total-unread-count");if(a.length){const n=Math.max(0,(parseInt(a.text())||0)-e);n>0?a.text(n):a.remove()}}$("#header-container").html(e.header),$(".skeleton-header-container").addClass("hidden"),$("#header-empty-state").addClass("hidden"),window.initializeChatDrawer&&window.initializeChatDrawer(),$("#all-messages").html(e.messages),$("#reply-form #conversation_id").val(a),$("#reply-form #channel").val(n),$("#messages-empty-state").addClass("hidden"),void 0!==e.currentPage?(messagePagination.currentPage=e.currentPage,messagePagination.hasPreviousPage=e.hasPreviousPage||!1,messagePagination.hasMorePages=void 0===e.hasMorePages||e.hasMorePages):(messagePagination.currentPage=1,messagePagination.hasPreviousPage=!1,messagePagination.hasMorePages=!0),messagePagination.isLoading=!1,setTimeout((function(){$(".skeleton-message-container").addClass("hidden");const e=$(".message-container");e.length>0?(e.removeClass("hidden"),setupMessageScrollListener(a),requestAnimationFrame((function(){scrollToBottom()})),setTimeout((function(){scrollToBottom()}),100),setTimeout((function(){scrollToBottom()}),300)):$("#messages-empty-state").removeClass("hidden")}),500)}})}function formatMessage(e){return`\n        <div class="message-item bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 border border-orange-200 dark:border-orange-700/50 rounded-2xl p-5 w-72 ml-auto">\n            <div class="flex items-start space-x-4">\n                <div class="flex-1">\n                    <p class="text-sm text-gray-800 dark:text-gray-200 leading-relaxed">\n                        ${e}\n                    </p>\n                    <div class="mt-4 flex items-center justify-between">\n                        <span class="text-xs text-orange-600 dark:text-orange-400 font-medium bg-orange-100 dark:bg-orange-900/50 px-3 py-1 rounded-full">\n                            ${time}\n                        </span>\n                    </div>\n                </div>\n            </div>\n        </div>`}function generateSkeletonLoader(){let e="";for(let a=0;a<6;a++)e+='\n            <div class="h-full max-h-[72px] w-full py-[14px] rounded-lg bg-white dark:bg-color-33 border border-white dark:border-color-47 animate-pulse">\n                <div class="flex gap-3 px-3">\n                    <div class="shrink-0 h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-700"></div>\n                    <div class="w-full">\n                        <div class="w-full flex items-center gap-[6px] justify-between">\n                            <div class="flex items-center gap-[6px]">\n                                <div class="h-4 w-16 bg-gray-200 dark:bg-gray-700 rounded"></div>\n                            </div>\n                            <div class="h-3 w-12 bg-gray-200 dark:bg-gray-700 rounded flex-shrink-0"></div>\n                        </div>\n                        <div class="mt-1 mb-0.5 h-4 w-32 bg-gray-200 dark:bg-gray-700 rounded"></div>\n                    </div>\n                </div>\n            </div>\n        ';return e}$(document).on("click",".delete-chat",(function(e){e.preventDefault(),e.stopPropagation();const a=$(this),n=a.data("chat-id"),o=a.data("chat-route"),r=a.closest(".sweet-modal"),s=r.find(".modalBox"),t=a.find(".loader"),i=r.find(".closeModalBtn");a.prop("disabled",!0),i.prop("disabled",!0),t.removeClass("hidden"),$.ajax({url:o,type:"DELETE",data:{_token:CSRF_TOKEN},beforeSend(e){e.setRequestHeader("Authorization",`Bearer ${ACCESS_TOKEN}`)},success:function(e){t.addClass("hidden"),toastMixin.fire({title:e.message||jsLang("Chat deleted successfully"),icon:"info"===e.status?"error":"success"}),r.removeClass("opacity-100"),s.removeClass("scale-100","opacity-100"),s.addClass("scale-0","opacity-0"),setTimeout((()=>{r.addClass("hidden")}),300),activeConversationId===n&&(activeConversationId=null);const a=$("#conversation-row-"+n);let o=null;if(o=a.next('[id^="conversation-row-"]'),0===o.length&&(o=a.prev('[id^="conversation-row-"]')),0===o.length){const e=$('[id^="conversation-row-"]').not("#conversation-row-"+n);e.length>0&&(o=e.first())}a.remove();const i=$('[id^="conversation-row-"]');if(o&&o.length>0){const e=o.find("[data-inbox-id]").first();e.length>0&&getMessages(e[0])}else if(0===i.length){const e=$("#conversation-list-container"),a=`\n                    <div class="flex flex-col items-center justify-center py-12 px-4">\n                        <svg class="w-16 h-16 text-gray-400 dark:text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>\n                        </svg>\n                        <p class="text-gray-600 dark:text-gray-400 text-sm font-medium mb-1">${jsLang("No conversations found")}</p>\n                        <p class="text-gray-500 dark:text-gray-500 text-xs text-center max-w-xs">${jsLang("Start a conversation to see messages here")}</p>\n                    </div>\n                `;if(e.html(a),$(".main-header-container").addClass("hidden"),$("#header-empty-state").removeClass("hidden"),$(".message-container").addClass("hidden"),$(".skeleton-message-container").addClass("hidden"),0===$("#messages-empty-state").length){const e=`\n                        <div id="messages-empty-state" class="p-5 h-[calc(100vh-184px)] overflow-y-auto flex flex-col items-center justify-center">\n                            <svg class="w-16 h-16 text-gray-400 dark:text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>\n                            </svg>\n                            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium mb-1">${jsLang("No messages yet")}</p>\n                            <p class="text-gray-500 dark:text-gray-500 text-xs text-center max-w-xs">${jsLang("Start the conversation by sending a message")}</p>\n                        </div>\n                    `;$("#all-messages").html(e)}else $("#messages-empty-state").removeClass("hidden");$("#reply-form")[0].reset(),$("#reply-form #conversation_id").val(""),$("#reply-form #channel").val(""),activeConversationId=null}},error:function(e){t.addClass("hidden"),a.prop("disabled",!1),i.prop("disabled",!1);const n=e.responseJSON?.error||jsLang("Failed to delete chat");toastMixin.fire({title:n,icon:"error"})}})})),$(document).on("submit","#reply-form",(function(e){e.preventDefault();const a=$(this),n=a.find('[name="conversation_id"]').val(),o=a.find('[name="message"]').val(),r=$(".message-container"),s=a.find("#send-message");if(!n||""===n)return void toastMixin.fire({title:jsLang("Please select a conversation first"),icon:"warning"});$("#messages-empty-state").addClass("hidden");const t=formatMessage(o);r.length>0&&(r.removeClass("hidden"),r.append(t),scrollToBottom()),$.ajax({url:`${SITE_URL}/user/marketing-bot/conversation/${n}/send/message`,type:"POST",data:a.serialize(),beforeSend(e){e.setRequestHeader("Authorization",`Bearer ${ACCESS_TOKEN}`),a.find('[name="message"]').val(""),s.attr("disabled","disabled")},success(e){if("info"===e.status)return toastMixin.fire({title:e.message,icon:"error"}),void s.removeAttr("disabled");s.removeAttr("disabled");const a=$("#conversation-row-"+n),o=a.parent();$('[id^="conversation-row-"]').removeClass("border-2 border-purple-200 dark:border-purple-700 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"),$('[id^="conversation-row-"]').addClass("bg-white dark:bg-color-33 border border-white dark:border-color-47 hover:border-color-89 dark:hover:border-color-89"),a.detach(),o.prepend(a),a.removeClass("bg-white dark:bg-color-33 border border-white dark:border-color-47 hover:border-color-89 dark:hover:border-color-89"),a.addClass("border-2 border-purple-200 dark:border-purple-700 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"),a.find(".conversation-time-"+n).text("Just now")},error(e){r.find(".message-item").first().remove(),s.removeAttr("disabled"),toastMixin.fire({title:e.responseJSON?.error||e.responseJSON?.message||jsLang("Failed to send message"),icon:"error"})}})})),$(document).ready((function(){const e=$("#conversation-list-container");if(0===e.length)return;const a=$("[data-inbox-id]").first();if(a.length>0){const e=a.attr("data-inbox-id");activeConversationId=e,getMessages(a[0])}else $("#conversation-skeleton-loader").addClass("hidden"),$("#conversation-empty-state").removeClass("hidden"),$(".skeleton-header-container").addClass("hidden"),$("#header-empty-state").removeClass("hidden"),$(".skeleton-message-container").addClass("hidden"),$("#messages-empty-state").removeClass("hidden"),$("#reply-form")[0].reset(),$("#reply-form #conversation_id").val(""),$("#reply-form #channel").val("");let n=!1,o=null,r="",s="all";function t(a=1,o=!1){if(n&&!o)return;if(!o){const e=$('[id^="conversation-row-"].border-2');if(e.length>0){const a=e.attr("id");activeConversationId=a?a.replace("conversation-row-",""):null}}n=!0;const t={page:a};r&&""!==r.trim()&&(t.search=r.trim()),s&&"all"!==s&&(t.channel=s),o&&$("#conversation-loading").removeClass("hidden"),$.ajax({url:`${SITE_URL}/user/marketing-bot/inbox`,type:"GET",data:t,headers:{"X-Requested-With":"XMLHttpRequest"},success:function(r){let s=!1;if(r&&r.html){const e=r.html.trim();if(""===e)s=!0;else if(-1===e.indexOf("conversation-row-"))s=!0;else{s=0===$("<div>").html(e).find('[id^="conversation-row-"]').length}}else s=!0;if(o)s||$("#conversation-loading").before(r.html);else if($("#conversation-skeleton-loader").addClass("hidden"),s?$("#conversation-empty-state").removeClass("hidden"):e.html(r.html),e.append('<div id="conversation-loading" class="hidden py-4 text-center"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900 dark:border-white"></div><p class="mt-2 text-sm text-gray-600 dark:text-gray-400">'+jsLang("Loading more conversations...")+"</p></div>"),activeConversationId&&!s){const e=$("#conversation-row-"+activeConversationId);if(e.length>0){$('[id^="conversation-row-"]').removeClass("border-2 border-purple-200 dark:border-purple-700 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"),$('[id^="conversation-row-"]').addClass("bg-white dark:bg-color-33 border border-white dark:border-color-47 hover:border-color-89 dark:hover:border-color-89"),e.removeClass("bg-white dark:bg-color-33 border border-white dark:border-color-47 hover:border-color-89 dark:hover:border-color-89"),e.addClass("border-2 border-purple-200 dark:border-purple-700 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200");const a=e.find("[data-inbox-id]").first();a.length>0&&getMessages(a[0])}}e.data("current-page",a),e.data("has-more",r.hasMorePages?"true":"false"),$("#conversation-loading").addClass("hidden"),n=!1},error:function(e){$("#conversation-loading").addClass("hidden"),o||($("#conversation-skeleton-loader").addClass("hidden"),$("#conversation-empty-state").removeClass("hidden")),toastMixin.fire({title:e.responseJSON?.message||jsLang("Failed to load conversations"),icon:"error"}),n=!1}})}$(document).on("click","#inbox-filter-toggle-btn",(function(e){e.stopPropagation(),$("#inbox-channel-filter-section").toggleClass("hidden")})),$(document).on("click","#inbox-channel-filter-btn",(function(e){e.preventDefault();$("#inbox-channel-menu").removeClass("hidden")})),$(document).on("click","#inbox-channel-menu",(function(e){e.stopPropagation()})),$(document).on("click","#inbox-channel-menu li",(function(e){e.stopPropagation()})),$(document).on("click",(function(e){const a=$(e.target),n=a.closest("#inbox-filter-toggle-btn").length>0,o=a.closest("#inbox-channel-filter-section").length>0,r=a.closest("#inbox-channel-filter-btn").length>0,s=a.closest("#inbox-channel-menu").length>0;r||s||$("#inbox-channel-menu").addClass("hidden"),n||o||$("#inbox-channel-filter-section").addClass("hidden")})),$("#inbox-search-input").on("input",(function(){const e=$(this).val();r=e,o&&clearTimeout(o),o=setTimeout((function(){t(1,!1)}),300)})),$(document).on("click","#inbox-channel-menu li",(function(e){e.stopPropagation();const a=$(this).data("channel"),n=$(this).text().trim();void 0!==a&&(s=a||"all",$("#inbox-channel-selected").text(n),$("#inbox-channel-menu").addClass("hidden"),t(1,!1))})),e.on("scroll",(function(){const a=$(this).scrollTop();if($(this)[0].scrollHeight-a-$(this).height()<=100&&!n){("true"===e.data("has-more")||!0===e.data("has-more"))&&function(){if(n)return;t((parseInt(e.data("current-page"))||1)+1,!0)}()}}))})),$(document).on("change","#auto-reply-toggle",(function(){const e=$(this).data("url"),a=$(this).is(":checked"),n=a?"on":"off",o=$(this).data("inbox-id");$.ajax({url:e,method:"POST",data:{_token:CSRF_TOKEN,inbox_id:o,ai_reply:n},success:function(e){toastMixin.fire({title:e.message||jsLang("Auto reply updated successfully"),icon:"success"})},error:function(e){$("#auto-reply-toggle").prop("checked",!a),toastMixin.fire({title:e.responseJSON?.message||jsLang("Failed to update auto reply"),icon:"error"})}})}));